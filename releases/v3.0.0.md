# v3.0.0 - Full Page Analytics

## Breaking Changes

Database schema updated. Migration will DROP and recreate workspace tables (events, sessions, pages).

**Action Required:** Back up any data before upgrading. This migration is destructive.

## New Features

### Pageview Count
- Track number of pages viewed per session
- New `pageview_count` column in sessions table
- New `pages_per_session` metric for analytics

### Page Duration Tracking
- Track exact focus time spent on each individual page
- SDK sends `previous_path` to correctly associate duration with the page being left
- SDK bug fixes to capture page duration correctly:
  - Fixed `onNavigation()` to capture duration BEFORE resetting timer
  - Fixed `flushOnce()` to include page duration in final unload ping
- New `page_duration` and `previous_path` columns in events table
- New `median_page_duration` column in sessions table (uses median for outlier robustness)
- New `median_page_duration` metric for analytics

### Pages Table
- New dedicated `pages` table for per-page analytics
- Tracks: path, duration, max_scroll, page_number, is_landing, is_exit
- Materialized view (`pages_mv`) auto-populates from screen_view events
- 7-day TTL matching events table

## Schema Changes

### Events Table
```sql
+ page_duration UInt32 DEFAULT 0
+ previous_path String DEFAULT ''
```

### Sessions Table
```sql
+ pageview_count UInt16 DEFAULT 1
+ median_page_duration UInt32 DEFAULT 0
```

### Sessions MV
```sql
+ countIf(e.name = 'screen_view') as pageview_count
+ round(medianIf(e.page_duration, e.page_duration > 0)) as median_page_duration
```

### New Pages Table
```sql
CREATE TABLE pages (
  id UUID,
  session_id String,
  workspace_id String,
  path String,
  full_url String,
  entered_at DateTime64(3),
  exited_at DateTime64(3),
  duration UInt32,
  max_scroll UInt8,
  page_number UInt8,
  is_landing Bool,
  is_exit Bool,
  entry_type LowCardinality(String),
  received_at DateTime64(3)
)
```

## New Metrics

| Metric | Description |
|--------|-------------|
| `pageviews` | Total pageviews (screen_view events) |
| `pages_per_session` | Average pages viewed per session |
| `median_page_duration` | Median time spent on each page (robust to outliers) |

## New Dimensions

| Dimension | Description |
|-----------|-------------|
| `pageview_count` | Number of pages viewed in session |

## Files Modified

### SDK (2 files)
- `sdk/src/types.ts` - Added `page_duration` and `previous_path` to TrackEventPayload
- `sdk/src/sdk.ts` - Bug fixes for page duration tracking, sends `previous_path` on navigation

### API Database (4 files)
- `api/src/database/schemas.ts` - Schema updates
- `api/src/migrations/versions/v3.migration.ts` - Migration implementation
- `api/src/migrations/migrations.registry.ts` - Migration registration
- `api/src/version.ts` - Version bump

### API Events (3 files)
- `api/src/events/dto/track-event.dto.ts` - DTO update
- `api/src/events/entities/event.entity.ts` - Entity update
- `api/src/events/events.service.ts` - Service update

### API Analytics (2 files)
- `api/src/analytics/constants/metrics.ts` - New metrics
- `api/src/analytics/constants/dimensions.ts` - New dimension

## Migration Guide

1. Stop the API server
2. Back up your ClickHouse data (if needed)
3. Update to v3.0.0
4. Start the API server - migration runs automatically
5. Migration will:
   - Drop existing workspace MVs and tables
   - Recreate with new schema
   - All historical data will be lost

## Notes

### Page Duration Semantics
- On SPA navigation: `screen_view` event contains `page_duration` (time on previous page) + `previous_path` (the page being left)
- On page unload: `ping` event contains `page_duration` for the current page (the final page)
- The `pages_mv` correctly associates duration with the right page using `previous_path`

### ClickHouse MV Limitations
- `exited_at` and `is_exit` in pages table cannot be retroactively updated
- For accurate exit analysis, calculate from session data at query time
