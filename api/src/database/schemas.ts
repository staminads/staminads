// System schemas - stored in staminads_system database
export const SYSTEM_SCHEMAS: Record<string, string> = {
  workspaces: `
    CREATE TABLE IF NOT EXISTS {database}.workspaces (
      id String,
      name String,
      website String,
      timezone String,
      currency String,
      logo_url String DEFAULT '',
      timescore_reference UInt32 DEFAULT 60,
      bounce_threshold UInt32 DEFAULT 10,
      status Enum8('initializing' = 1, 'active' = 2, 'inactive' = 3, 'error' = 4),
      custom_dimensions String DEFAULT '[]',
      filters String DEFAULT '[]',
      geo_enabled Bool DEFAULT true,
      geo_store_city Bool DEFAULT true,
      geo_store_region Bool DEFAULT true,
      geo_coordinates_precision UInt8 DEFAULT 2,
      integrations String DEFAULT '[]',
      created_at DateTime64(3) DEFAULT now64(3),
      updated_at DateTime64(3) DEFAULT now64(3)
    ) ENGINE = MergeTree()
    ORDER BY id
  `,

  backfill_tasks: `
    CREATE TABLE IF NOT EXISTS {database}.backfill_tasks (
      id String,
      workspace_id String,
      status Enum8('pending' = 1, 'running' = 2, 'completed' = 3, 'failed' = 4, 'cancelled' = 5),
      lookback_days UInt16,
      chunk_size_days UInt8 DEFAULT 1,
      batch_size UInt32 DEFAULT 5000,
      total_sessions UInt64 DEFAULT 0,
      processed_sessions UInt64 DEFAULT 0,
      total_events UInt64 DEFAULT 0,
      processed_events UInt64 DEFAULT 0,
      current_date_chunk Nullable(Date),
      created_at DateTime64(3) DEFAULT now64(3),
      updated_at DateTime64(3) DEFAULT now64(3),
      started_at Nullable(DateTime64(3)),
      completed_at Nullable(DateTime64(3)),
      error_message String DEFAULT '',
      retry_count UInt8 DEFAULT 0,
      dimensions_snapshot String DEFAULT '[]',
      filters_snapshot String DEFAULT '[]'
    ) ENGINE = ReplacingMergeTree(updated_at)
    ORDER BY id
  `,
};

// Workspace schemas - stored in staminads_ws_{workspace_id} databases
// Note: workspace_id removed from ORDER BY and indexes since each database is per-workspace
export const WORKSPACE_SCHEMAS: Record<string, string> = {
  events: `
    CREATE TABLE IF NOT EXISTS {database}.events (
      id UUID DEFAULT generateUUIDv4(),
      session_id String,
      workspace_id String,
      created_at DateTime64(3),
      name LowCardinality(String),
      path String,
      duration UInt64 DEFAULT 0,
      referrer String DEFAULT '',
      referrer_domain String DEFAULT '',
      referrer_path String DEFAULT '',
      is_direct Bool DEFAULT false,
      landing_page String,
      landing_domain String DEFAULT '',
      landing_path String DEFAULT '',
      utm_source String DEFAULT '',
      utm_medium String DEFAULT '',
      utm_campaign String DEFAULT '',
      utm_term String DEFAULT '',
      utm_content String DEFAULT '',
      utm_id String DEFAULT '',
      utm_id_from String DEFAULT '',
      channel LowCardinality(String) DEFAULT '',
      channel_group LowCardinality(String) DEFAULT '',
      cd_1 String DEFAULT '',
      cd_2 String DEFAULT '',
      cd_3 String DEFAULT '',
      cd_4 String DEFAULT '',
      cd_5 String DEFAULT '',
      cd_6 String DEFAULT '',
      cd_7 String DEFAULT '',
      cd_8 String DEFAULT '',
      cd_9 String DEFAULT '',
      cd_10 String DEFAULT '',
      screen_width UInt16 DEFAULT 0,
      screen_height UInt16 DEFAULT 0,
      viewport_width UInt16 DEFAULT 0,
      viewport_height UInt16 DEFAULT 0,
      device String DEFAULT '',
      browser String DEFAULT '',
      browser_type String DEFAULT '',
      os String DEFAULT '',
      user_agent String DEFAULT '',
      connection_type String DEFAULT '',
      language String DEFAULT '',
      timezone String DEFAULT '',
      country LowCardinality(String) DEFAULT '',
      region LowCardinality(String) DEFAULT '',
      city String DEFAULT '',
      latitude Nullable(Float32),
      longitude Nullable(Float32),
      max_scroll UInt8 DEFAULT 0,
      sdk_version String DEFAULT '',
      properties Map(String, String) DEFAULT map(),
      INDEX idx_name name TYPE bloom_filter(0.01) GRANULARITY 1,
      INDEX idx_browser_type browser_type TYPE set(10) GRANULARITY 1
    ) ENGINE = MergeTree()
    PARTITION BY toYYYYMMDD(created_at)
    ORDER BY (session_id, created_at)
    TTL created_at + INTERVAL 7 DAY
  `,

  sessions: `
    CREATE TABLE IF NOT EXISTS {database}.sessions (
      id String,
      workspace_id String,
      created_at DateTime64(3),
      updated_at DateTime64(3),
      duration UInt32 DEFAULT 0,
      year UInt16,
      month UInt8,
      day UInt8,
      day_of_week UInt8,
      week_number UInt8,
      hour UInt8,
      is_weekend Bool,
      referrer String DEFAULT '',
      referrer_domain String DEFAULT '',
      referrer_path String DEFAULT '',
      is_direct Bool,
      landing_page String,
      landing_domain String DEFAULT '',
      landing_path String DEFAULT '',
      entry_page String DEFAULT '',
      exit_page String DEFAULT '',
      utm_source String DEFAULT '',
      utm_medium String DEFAULT '',
      utm_campaign String DEFAULT '',
      utm_term String DEFAULT '',
      utm_content String DEFAULT '',
      utm_id String DEFAULT '',
      utm_id_from String DEFAULT '',
      channel LowCardinality(String) DEFAULT '',
      channel_group LowCardinality(String) DEFAULT '',
      cd_1 String DEFAULT '',
      cd_2 String DEFAULT '',
      cd_3 String DEFAULT '',
      cd_4 String DEFAULT '',
      cd_5 String DEFAULT '',
      cd_6 String DEFAULT '',
      cd_7 String DEFAULT '',
      cd_8 String DEFAULT '',
      cd_9 String DEFAULT '',
      cd_10 String DEFAULT '',
      screen_width UInt16 DEFAULT 0,
      screen_height UInt16 DEFAULT 0,
      viewport_width UInt16 DEFAULT 0,
      viewport_height UInt16 DEFAULT 0,
      user_agent String DEFAULT '',
      language String DEFAULT '',
      timezone String DEFAULT '',
      country LowCardinality(String) DEFAULT '',
      region LowCardinality(String) DEFAULT '',
      city String DEFAULT '',
      latitude Nullable(Float32),
      longitude Nullable(Float32),
      browser String DEFAULT '',
      browser_type String DEFAULT '',
      os String DEFAULT '',
      device String DEFAULT '',
      connection_type String DEFAULT '',
      max_scroll UInt8 DEFAULT 0,
      sdk_version String DEFAULT '',
      INDEX idx_created_at created_at TYPE minmax GRANULARITY 1
    ) ENGINE = ReplacingMergeTree(updated_at)
    PARTITION BY toYYYYMM(created_at)
    ORDER BY (created_at, id)
  `,

  sessions_mv: `
    CREATE MATERIALIZED VIEW IF NOT EXISTS {database}.sessions_mv
    TO {database}.sessions AS
    SELECT
      session_id as id,
      workspace_id,
      min(events.created_at) as created_at,
      max(events.created_at) as updated_at,
      dateDiff('second', min(events.created_at), max(events.created_at)) as duration,
      argMin(toYear(events.created_at), events.created_at) as year,
      argMin(toMonth(events.created_at), events.created_at) as month,
      argMin(toDayOfMonth(events.created_at), events.created_at) as day,
      argMin(toDayOfWeek(events.created_at), events.created_at) as day_of_week,
      argMin(toWeek(events.created_at), events.created_at) as week_number,
      argMin(toHour(events.created_at), events.created_at) as hour,
      argMin(toDayOfWeek(events.created_at) IN (6, 7), events.created_at) as is_weekend,
      argMin(referrer, events.created_at) as referrer,
      argMin(referrer_domain, events.created_at) as referrer_domain,
      argMin(referrer_path, events.created_at) as referrer_path,
      argMin(is_direct, events.created_at) as is_direct,
      argMin(landing_page, events.created_at) as landing_page,
      argMin(landing_domain, events.created_at) as landing_domain,
      argMin(landing_path, events.created_at) as landing_path,
      argMin(path, events.created_at) as entry_page,
      argMax(path, events.created_at) as exit_page,
      argMin(utm_source, events.created_at) as utm_source,
      argMin(utm_medium, events.created_at) as utm_medium,
      argMin(utm_campaign, events.created_at) as utm_campaign,
      argMin(utm_term, events.created_at) as utm_term,
      argMin(utm_content, events.created_at) as utm_content,
      argMin(utm_id, events.created_at) as utm_id,
      argMin(utm_id_from, events.created_at) as utm_id_from,
      argMin(channel, events.created_at) as channel,
      argMin(channel_group, events.created_at) as channel_group,
      argMin(cd_1, events.created_at) as cd_1,
      argMin(cd_2, events.created_at) as cd_2,
      argMin(cd_3, events.created_at) as cd_3,
      argMin(cd_4, events.created_at) as cd_4,
      argMin(cd_5, events.created_at) as cd_5,
      argMin(cd_6, events.created_at) as cd_6,
      argMin(cd_7, events.created_at) as cd_7,
      argMin(cd_8, events.created_at) as cd_8,
      argMin(cd_9, events.created_at) as cd_9,
      argMin(cd_10, events.created_at) as cd_10,
      any(screen_width) as screen_width,
      any(screen_height) as screen_height,
      any(viewport_width) as viewport_width,
      any(viewport_height) as viewport_height,
      any(user_agent) as user_agent,
      any(language) as language,
      any(timezone) as timezone,
      any(country) as country,
      any(region) as region,
      any(city) as city,
      any(latitude) as latitude,
      any(longitude) as longitude,
      any(browser) as browser,
      any(browser_type) as browser_type,
      any(os) as os,
      any(device) as device,
      any(connection_type) as connection_type,
      max(max_scroll) as max_scroll,
      any(sdk_version) as sdk_version
    FROM {database}.events
    GROUP BY session_id, workspace_id
  `,
};
